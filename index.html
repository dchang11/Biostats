<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Biostatistics Graphing App</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script> <!-- For plotting graphs -->
  <script src="https://unpkg.com/simple-statistics@7.8.3/dist/simple-statistics.min.js"></script> <!-- For regression calculations -->
  <style>
    body { font-family: sans-serif; padding: 20px; }
    input, select, button { margin: 10px 0; }
    #plot { width: 100%; max-width: 800px; height: 500px; }
  </style>
</head>
<body>
  <h1>ðŸ“Š Biostatistics Graphing App</h1>

  <!-- Upload CSV file -->
  <input type="file" id="fileInput" accept=".csv" />

  <!-- Select regression type -->
  <label for="regression">Choose regression:</label>
  <select id="regression">
    <option value="none">None</option>
    <option value="linear">Linear</option>
    <option value="exponential">Exponential</option>
  </select>

  <!-- Download button for saving graph as image -->
  <button onclick="downloadGraph()">Download Graph</button>

  <!-- Where the graph will be displayed -->
  <div id="plot"></div>

  <script>
    // When a CSV file is selected...
    document.getElementById('fileInput').addEventListener('change', function(event) {
      const file = event.target.files[0];
      const reader = new FileReader();

      // After file is loaded, parse the CSV and plot it
      reader.onload = function(e) {
        const rows = e.target.result.trim().split('\n');
        const x = [], y = [];

        // Assume first row is headers, skip it
        for (let i = 1; i < rows.length; i++) {
          const [xVal, yVal] = rows[i].split(',').map(Number);
          x.push(xVal);
          y.push(yVal);
        }

        // Get selected regression type
        const regressionType = document.getElementById('regression').value;
        plotData(x, y, regressionType);
      };

      reader.readAsText(file); // Read CSV file as plain text
    });

    // Main function to plot data and regression
    function plotData(x, y, regressionType) {
      const trace = {
        x: x,
        y: y,
        mode: 'markers',
        type: 'scatter',
        name: 'Data Points'
      };

      const data = [trace];

      // Add regression line if selected
      if (regressionType === 'linear') {
        const lr = ss.linearRegression(x.map((xi, i) => [xi, y[i]]));
        const line = ss.linearRegressionLine(lr);
        const xLine = [...x].sort((a, b) => a - b); // Sorted x for smooth line
        const yLine = xLine.map(line);
        data.push({
          x: xLine,
          y: yLine,
          mode: 'lines',
          name: 'Linear Regression'
        });

      } else if (regressionType === 'exponential') {
        // Fit to y = a * e^(b * x)
        const logY = y.map(Math.log);
        const lr = ss.linearRegression(x.map((xi, i) => [xi, logY[i]]));
        const a = Math.exp(lr.b), b = lr.m;
        const xLine = [...x].sort((a, b) => a - b);
        const yLine = xLine.map(xi => a * Math.exp(b * xi));
        data.push({
          x: xLine,
          y: yLine,
          mode: 'lines',
          name: 'Exponential Regression'
        });
      }
